/* Price shock for non-FX forward and Comm derivatives */
SELECT aa.INSTR_ID, aa.TYPE, 
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE TYPE <> 80 AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, VALUE FORWARD_VALUE
    FROM PFEDIM.FORWARD_VALUE
    WHERE HORIZON_ID = 1 AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID;

/* Price shock for FX forward and Comm derivatives in CVADIM.AVG_EXPOSURE */ 
SELECT aa.INSTR_ID, aa.TYPE, 
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, CVA+DVA FORWARD_VALUE
    FROM CVADIM.AVG_EXPOSURE
    WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID;

/* Price shock for FX forwards and Comm derivatives in PFEDIM.POSITION */
SELECT aa.INSTR_ID, aa.TYPE, 
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT a.INSTR_ID, a.DATE_ID, a.FORWARD_VALUE 
FROM (        
    SELECT INSTR_ID, DATE_ID, MARKET_VALUE FORWARD_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
     ) a
    LEFT JOIN (
    SELECT INSTR_ID, DATE_ID
    FROM CVADIM.AVG_EXPOSURE
    WHERE SCENARIO_ID = 'Base' and HORIZON_ID = 1
    )  b
    ON a.DATE_ID = b.DATE_ID
        AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID;


SELECT rawdata.INSTR_ID, rawdata.TYPE,
        rawdata.HORIZON, target.SUB_TYPE, 
        target.BUY_CCY, target.SELL_CCY,
        target.INS_B_S_CODE, target.CALL_PUT, 
        rawdata.FORWARD_VALUE, rawdata.MARKET_VALUE, rawdata.SHOCK
FROM
(SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE TYPE <> 80 AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, VALUE FORWARD_VALUE
    FROM PFEDIM.FORWARD_VALUE
    WHERE HORIZON_ID = 1 AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID
UNION
SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, CVA+DVA FORWARD_VALUE
    FROM CVADIM.AVG_EXPOSURE
    WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID
UNION
SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT a.INSTR_ID, a.DATE_ID, a.FORWARD_VALUE 
FROM (        
    SELECT INSTR_ID, DATE_ID, MARKET_VALUE FORWARD_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
     ) a
    LEFT JOIN (
    SELECT INSTR_ID, DATE_ID
    FROM CVADIM.AVG_EXPOSURE
    WHERE SCENARIO_ID = 'Base' and HORIZON_ID = 1
    )  b
    ON a.DATE_ID = b.DATE_ID
        AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID) rawdata
INNER JOIN
(SELECT INSTR_ID, DATE_ID, SUB_TYPE, BUY_CCY, 
       SELL_CCY, INS_B_S_CODE, CALL_PUT
FROM PFEDIM.FXO_POSITION) target
ON rawdata.instr_ID = target.instr_ID and rawdata.pfe = target.date_id;







SELECT rawdata.INSTR_ID, rawdata.TYPE,
        rawdata.HORIZON,  
        target.BUY_CCY, target.SELL_CCY,
        rawdata.FORWARD_VALUE, rawdata.MARKET_VALUE, rawdata.SHOCK
FROM
(SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE TYPE <> 80 AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, VALUE FORWARD_VALUE
    FROM PFEDIM.FORWARD_VALUE
    WHERE HORIZON_ID = 1 AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID
UNION
SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, CVA+DVA FORWARD_VALUE
    FROM CVADIM.AVG_EXPOSURE
    WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID
UNION
SELECT aa.INSTR_ID, aa.TYPE, bb.DATE_ID pfe, aa.DATE_ID mtm,
        TO_CHAR(dd.CALENDAR_DATE, 'mm/dd/yyyy') || ' - ' || TO_CHAR(cc.CALENDAR_DATE, 'mm/dd/yyyy') HORIZON, 
        bb.FORWARD_VALUE, aa.MARKET_VALUE, aa.MARKET_VALUE - bb.FORWARD_VALUE SHOCK
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT a.INSTR_ID, a.DATE_ID, a.FORWARD_VALUE 
FROM (        
    SELECT INSTR_ID, DATE_ID, MARKET_VALUE FORWARD_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
     ) a
    LEFT JOIN (
    SELECT INSTR_ID, DATE_ID
    FROM CVADIM.AVG_EXPOSURE
    WHERE SCENARIO_ID = 'Base' and HORIZON_ID = 1
    )  b
    ON a.DATE_ID = b.DATE_ID
        AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aa.DATE_ID = cc.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE dd
ON bb.DATE_ID = dd.DATE_ID) rawdata
INNER JOIN
(SELECT INSTR_ID, DATE_ID, BUY_CCY, SELL_CCY 
FROM PFEDIM.FXR_POSITION) target
ON rawdata.instr_ID = target.instr_ID and rawdata.pfe = target.date_id;

/* Get the fwd value and mkt value for transactions of type 3, 21 and 22 on pfe dates*/
select aaa.instr_id, cc.calendar_date, aaa.type, aaa.market_value, bbb.FWD_VALUE
from ( 
select instr_id, date_id, type, market_value from pfedim.position
    where date_id in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)) aaa
inner join (
SELECT aa.INSTR_ID INSTR_ID, bb.date_id PFE_DATE, aa.date_id MTM_DATE, 
        aa.MARKET_VALUE MKT_VALUE, bb.FORWARD_VALUE FWD_VALUE 
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MARKET_VALUE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT INSTR_ID, DATE_ID, CVA+DVA FORWARD_VALUE
    FROM CVADIM.AVG_EXPOSURE
    WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID) bbb
on aaa.instr_id = bbb.instr_id and aaa.date_id = bbb.pfe_date
INNER JOIN PFEDIM.CALENDAR_DATE cc
ON aaa.DATE_ID = cc.DATE_ID;
            

SELECT aa.INSTR_ID, aa.TYPE, 
        aa.MATURITY_DATE
FROM (
    SELECT INSTR_ID, TYPE, DATE_ID, MATURITY_DATE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18380, 18389, 18399, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509, 18518)
    ) aa
INNER JOIN (
    SELECT a.INSTR_ID, a.DATE_ID, a.MATURITY_DATE 
FROM (        
    SELECT INSTR_ID, DATE_ID, MATURITY_DATE
    FROM PFEDIM.POSITION
    WHERE (TYPE = 3 OR TYPE = 21 OR TYPE = 22) AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 
            18186, 18196, 18205, 18215, 18225, 18235, 18244, 18254, 18264, 18274, 
            18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 18361, 18370, 
            18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 18470, 
            18480, 18490, 18499, 18509)
     ) a
    LEFT JOIN (
    SELECT INSTR_ID, DATE_ID
    FROM CVADIM.AVG_EXPOSURE
    WHERE SCENARIO_ID = 'Base' and HORIZON_ID = 1
    )  b
    ON a.DATE_ID = b.DATE_ID
        AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL
    ) bb
ON aa.DATE_ID BETWEEN bb.DATE_ID + 1 AND bb.DATE_ID + 13
    AND aa.INSTR_ID = bb.INSTR_ID;