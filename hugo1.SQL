select * from pfedim.FXR_POSITION;

select * from PFEDIM.POSITION_ATTRIBUTION; 

select * from CVADIM.POSITION_ATTRIBUTION ;

select * from PFEDIM.FORWARD_VALUE where HORIZON_ID = 1;

select * from PFEDIM.POSITION;

SELECT * FROM PFEDIM.FXO_POSITION; 

SELECT * FROM PFEDIM.POSITION a
    INNER JOIN PFEDIM.FXO_POSITION b
    ON a.INSTR_ID = b.INSTR_ID;

select * from CVADIM.AVG_EXPOSURE WHERE SCENARIO_ID = 'Base' AND HORIZON_ID = 1;

select * from CVADIM.AVG_EXPOSURE where SCENARIO_ID = 'Base' and HORIZON_ID = 1
and instr_id not in (select instr_id from pfedim.forward_value);

select * from cvadim.avg_exposure a left join pfedim.position b
    on A.INSTR_ID = b.instr_id and a.date_id = b.date_id where b.date_id is null;

select * from PFEDIM.CALENDAR_DATE;

select * from pfedim.product_type;

/* Pull the Market Value */
(SELECT a.INSTR_ID,
       a.TYPE,
       c.CALENDAR_DATE REALIZED_MTM_DATE,
       a.COUNTERPARTY_ID,
       a.MARKET_VALUE
       FROM (
        SELECT * 
        FROM PFEDIM.POSITION
        WHERE DATE_ID in (18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18380, 18389, 18399, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509, 18518)
        AND TYPE <> 80
       ) a
       INNER JOIN (
         SELECT * FROM PFEDIM.FORWARD_VALUE 
         WHERE HORIZON_ID = 1 AND DATE_ID in (18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18380, 18389, 18399, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509, 18518)
       ) b
        ON a.INSTR_ID = b.INSTR_ID AND a.DATE_ID = b.DATE_ID
       INNER JOIN PFEDIM.CALENDAR_DATE c
        ON a.DATE_ID = c.DATE_ID)
UNION
(SELECT a.INSTR_ID,
       a.TYPE,
       c.CALENDAR_DATE REALIZED_MTM_DATE,
       a.COUNTERPARTY_ID,
       a.MARKET_VALUE
       FROM (
        SELECT * 
        FROM PFEDIM.POSITION
        WHERE DATE_ID in (18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18380, 18389, 18399, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509, 18518)
        AND TYPE <> 80
       ) a
       INNER JOIN (
         SELECT * 
         FROM CVADIM.AVG_EXPOSURE 
         WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID in (18138, 18148, 
            18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
            18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 
            18352, 18361, 18370, 18380, 18389, 18399, 18412, 18421, 18431, 18441, 
            18450, 18460, 18470, 18480, 18490, 18499, 18509, 18518)
       ) b
        ON a.INSTR_ID = b.INSTR_ID AND a.DATE_ID = b.DATE_ID
       INNER JOIN PFEDIM.CALENDAR_DATE c
        ON a.DATE_ID = c.DATE_ID)
UNION
(SELECT a.INSTR_ID,
       a.TYPE,
       c.CALENDAR_DATE REALIZED_MTM_DATE,
       a.COUNTERPARTY_ID,
       a.MARKET_VALUE
       FROM 
       (SELECT * FROM PFEDIM.POSITION
        WHERE DATE_ID in (18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18380, 18389, 18399, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509, 18518)
        AND (TYPE = 3 OR TYPE = 21 OR TYPE = 22)) a
       INNER JOIN PFEDIM.CALENDAR_DATE c
        ON a.DATE_ID = c.DATE_ID)
ORDER BY REALIZED_MTM_DATE;


/* Pull the Forward Value for non-FX-Forwards and non-Commodity-derivatives */
/* Notice that PFEDIM.FORWARD_VALUE does not contain transactions with type = 3, 21 or 22*/
SELECT aa.INSTR_ID,
       aa.TYPE,
       cc.CALENDAR_DATE PFE_DATE,
       aa.COUNTERPARTY_ID,
       bb.FORWARD_VALUE
FROM (
      SELECT * 
        FROM PFEDIM.POSITION
        WHERE DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18381, 18390, 18402, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509)
        AND TYPE <> 80
       ) aa
INNER JOIN
(SELECT DATE_ID, INSTR_ID, VALUE FORWARD_VALUE 
        FROM PFEDIM.FORWARD_VALUE  
        WHERE HORIZON_ID = 1 AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18381, 18390, 18402, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509)) bb
ON
    aa.INSTR_ID = bb.INSTR_ID AND aa.DATE_ID = bb.DATE_ID
INNER JOIN PFEDIM.CALENDAR_DATE cc
        ON aa.DATE_ID = cc.DATE_ID;

/* Pull the Forward Value for FX Forwards and Commodity derivatives */
/* Part1: Transactions in CVADIM.AVG_EXPOSURE */
SELECT aa.INSTR_ID,
       aa.TYPE,
       cc.CALENDAR_DATE PFE_DATE,
       aa.COUNTERPARTY_ID,
       bb.FORWARD_VALUE
FROM (
        SELECT * 
        FROM PFEDIM.POSITION
        WHERE DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18381, 18390, 18402, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509)
        AND (TYPE = 3 OR TYPE = 21 OR TYPE = 22)
       ) aa
    INNER JOIN (
        SELECT DATE_ID, INSTR_ID, CVA+DVA FORWARD_VALUE 
        FROM CVADIM.AVG_EXPOSURE  
        WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID IN (18130, 18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18381, 18390, 18402, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509)
           ) bb
    ON
        aa.INSTR_ID = bb.INSTR_ID AND aa.DATE_ID = bb.DATE_ID
    INNER JOIN PFEDIM.CALENDAR_DATE cc
    ON aa.DATE_ID = cc.DATE_ID;
        
/* Part2: Transactions not in CVADIM.AVG_EXPOSURE uses Market Value instead */   

  
SELECT aa.INSTR_ID,
       aa.TYPE,       
       aa.DATE_ID,
       aa.COUNTERPARTY_ID,
       aa.MARKET_VALUE FORWARD_VALUE
FROM (
        SELECT DATE_ID, TYPE, INSTR_ID, COUNTERPARTY_ID, MARKET_VALUE 
        FROM PFEDIM.POSITION
        WHERE DATE_ID in (18130, 18138, 18148, 18157, 18167, 18176, 18186, 18196, 18205,
            18215, 18225, 18235, 18244, 18254, 18264, 18274, 18284, 18294, 18304, 18313,
            18323, 18333, 18342, 18352, 18361, 18370, 18381, 18390, 18402, 18412, 18421,
            18431, 18441, 18450, 18460, 18470, 18480, 18490, 18499, 18509)
        AND (TYPE = 3 OR TYPE = 21 AND TYPE = 22)
      ) aa
    LEFT JOIN (
        SELECT DATE_ID, INSTR_ID
        FROM CVADIM.AVG_EXPOSURE
            WHERE HORIZON_ID = 1 AND SCENARIO_ID = 'Base' AND DATE_ID IN (18130, 18138, 
                18148, 18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
                18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 
                18361, 18370, 18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 
                18470, 18480, 18490, 18499, 18509)   
    ) bb
    ON aa.DATE_ID = bb.DATE_ID AND aa.INSTR_ID = bb.INSTR_ID
    WHERE bb.DATE_ID IS NULL;  
    
        
SELECT aa.INSTR_ID, aa.TYPE, aa.DATE_ID 
FROM (
    SELECT DATE_ID, INSTR_ID, TYPE
    FROM PFEDIM.POSITION
) aa
INNER JOIN (
SELECT a.DATE_ID, a.INSTR_ID
FROM (
    SELECT DATE_ID, INSTR_ID
    FROM CVADIM.AVG_EXPOSURE
        WHERE SCENARIO_ID = 'Base' AND HORIZON_ID = 1 AND DATE_ID IN (18130, 18138, 
                18148, 18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
                18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 
                18361, 18370, 18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 
                18470, 18480, 18490, 18499, 18509)
) a
LEFT JOIN (
    SELECT DATE_ID, INSTR_ID
    FROM PFEDIM.FORWARD_VALUE
        WHERE HORIZON_ID = 1 AND DATE_ID IN (18130, 18138, 
                18148, 18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
                18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 
                18361, 18370, 18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 
                18470, 18480, 18490, 18499, 18509)
) b
ON a.DATE_ID = b.DATE_ID 
    AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL
) bb
ON aa.DATE_ID = bb.DATE_ID 
    AND aa.INSTR_ID = bb.INSTR_ID
WHERE TYPE = 05;

SELECT a.DATE_ID, a.INSTR_ID
FROM (
    SELECT DATE_ID, INSTR_ID
    FROM CVADIM.AVG_EXPOSURE
        WHERE SCENARIO_ID = 'Base' AND HORIZON_ID = 1 AND DATE_ID IN (18130, 18138, 
                18148, 18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
                18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 
                18361, 18370, 18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 
                18470, 18480, 18490, 18499, 18509)
) a
LEFT JOIN (
    SELECT DATE_ID, INSTR_ID
    FROM PFEDIM.FORWARD_VALUE
        WHERE HORIZON_ID = 1 AND DATE_ID IN (18130, 18138, 
                18148, 18157, 18167, 18176, 18186, 18196, 18205, 18215, 18225, 18235, 18244, 
                18254, 18264, 18274, 18284, 18294, 18304, 18313, 18323, 18333, 18342, 18352, 
                18361, 18370, 18381, 18390, 18402, 18412, 18421, 18431, 18441, 18450, 18460, 
                18470, 18480, 18490, 18499, 18509)
) b
ON a.DATE_ID = b.DATE_ID 
    AND a.INSTR_ID = b.INSTR_ID
    WHERE b.DATE_ID IS NULL;
    
SELECT * FROM PFEDIM.FORWARD_VALUE WHERE INSTR_ID = 3571327 AND DATE_ID = 18196;

SELECT * FROM CVADIM.AVG_EXPOSURE WHERE SCENARIO_ID = 'Base'
    AND HORIZON_ID = 1 AND INSTR_ID = 3571327 AND DATE_ID = 18196;

SELECT * FROM PFEDIM.POSITION WHERE INSTR_ID = 3571327 AND DATE_ID = 18196;











